<link rel="import" href="../paper-filter/paper-filter.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<link rel="import" href="add-element.html">
<!--
`<open-elements>` 
@demo demo.html
-->

<dom-module id="open-elements">
  <template>
    <iron-ajax auto url="/list-of-elements" handle-as="text" last-response="{{list}}"></iron-ajax>
    <iron-ajax auto url="/imports" handle-as="text" last-response="{{imports}}"></iron-ajax>
    <iron-ajax auto url="/tests" handle-as="text" last-response="{{tests}}"></iron-ajax>
    
    <paper-filter show-numbers="true" min="3" data="{{data}}" by="group" output="{{output}}"></paper-filter>
    
      <table>
        <thead>
          <tr>
            <th>Element</th>
            <th>Docs</th>
            <th>Code</th>
            <th>Test</th>
            <th>Used By</th>
            <th>Imports</th>
          </tr>
        </thead>
        <tbody>
          <template is="dom-repeat" items="{{output}}" sort="sort">
            <tr>
              <td>{{item.name}}</td>
              <td><a href="{{item.folder}}">docs</a></td>
              <td><a href="{{item.file}}">&lt;/&gt;</a></td>
              <td>
                <template is="dom-if" if="{{hasTest(item.name, tests)}}">
                  <a href="{{item.test}}">test</a>
                </template>
              </td>
              <td title="{{title(item.imports.usedBy)}}">
                <template is="dom-if" if="{{item.imports.usedBy.length}}">
                  <a title="{{title(item.imports.usedBy)}}">
                    {{item.imports.usedBy.length}}
                  </a>
                </template>
              </td>
              <td title="{{title(item.imports.users)}}">
                <template is="dom-if" if="{{item.imports.users.length}}">
                  <a title="{{title(item.imports.users)}}">
                    {{item.imports.users.length}}
                  </a>
                </template>
              </td>
            </tr> 
          </template>
        </tbody>
      </table>
      
    <p><a href="https://open-elements.org/bower_components/polymer/">Polymer Docs</a></p>
    <p><a href="https://open-elements.org/bower_components/pair-production/demo.html">Make an Element</a></p>
    <p><a href="https://github.com/marcus7777/open-elements/edit/master/open-elements.html">Fork me I'm yours</a></p>
    
    <add-element></add-element>
  </template>
</dom-module>
<script>
  Polymer({
    is: "open-elements",
    properties: {
      data: {computed:'getData(list, imports)'},
    },
    getData: function(list, imports) {
      var output = []
      var isAnElement= []
      var elements = list.split('\n')
      var importsList = imports.split('\n')
      
      function countImports (file) {
        var usedBy = []
        var users = []
        
        for (var ic = 0; ic < importsList.length; ++ic) {
          var line = importsList[ic].split(':rel="import" href="../')
          if (line.length === 2) {
            if (line[0].indexOf(file) !== -1) {
              users.push(line[1])
            } else if (line[1].indexOf(file) !== -1) {
              usedBy.push(line[0])
            }
          }
        }
        return {users: users, usedBy: usedBy}
      }
      for (var i = 0; i < elements.length; ++i) {
        var path = elements[i].split('/')
        var file = path.pop()
        var folder = path.pop()
        if (file.indexOf("-") !== -1 && file === folder + ".html" ) {
          isAnElement.push(folder)
        }
      }
      for (var i = 0; i < elements.length; ++i) {
        var path = elements[i].split('/')
        var file = path.pop()
        var folder = path.pop()
        if (isAnElement.indexOf(folder) !== -1 && file.indexOf("-") !== -1) {
          output.push({
            group:file.slice(0, file.indexOf("-")), 
            name: file.replace('.html',''),
            bower: folder,
            imports: countImports(folder+'/'+file),
            folder: '/'+path+'/'+folder,
            test: '/'+path+'/'+folder+'/test/',
            file: 'view-source:https://open-elements.org/'+path+'/'+folder+'/'+file
          })
        }
      }
      return output
    },
    hasTest: function(path, tests) {
      return -1 !== tests.indexOf(path)
    },
    title: function(title) {
      return title.join("\n").replace(new RegExp("bower_components/", 'g'),"")
    },
    sort: function(a,b) {
      if (a && b) {
        if (a.imports.usedBy.length !== b.imports.usedBy.length) {
          return a.imports.usedBy.length < b.imports.usedBy.length
        } else if (a.name !== b.name) {
          return a.name < b.name
        } 
        
      }
    }
  })
</script>
